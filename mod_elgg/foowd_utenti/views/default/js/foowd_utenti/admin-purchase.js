// Generated by CoffeeScript 1.10.0
(function() {
  (function(root, factory) {
    if (typeof define === 'function' && define.amd) {
      return define(['elgg', 'jquery', 'foowdServices'], factory);
    } else if (typeof exports === 'object') {
      return module.exports = factory();
    } else {
      return root.returnExports = factory();
    }
  })(this, function() {
    var $, _actionClose, _advise, closing, serv;
    $ = require('jquery');
    serv = require('foowdServices');
    _advise = function(obj) {
      return $("<div></div>").html(obj.outputMsg).dialog({
        title: obj.titleMsg,
        resizable: false,
        modal: true,
        buttons: {
          "Ok": function() {
            if (obj.actionClose === true) {
              _actionClose(obj);
            }
            $(this).dialog("close");
            if (typeof obj.callbackBtn === 'function') {
              return obj.callbackBtn();
            }
          },
          "Annulla": function() {
            return $(this).dialog("close");
          }
        }
      });
    };
    _actionClose = function(obj) {
      console.log('chiudo id ' + obj.id);
      return serv.purchaseSolve(obj.id).then(function(data) {
        var loom;
        obj.actionClose = false;
        console.log(data);
        loom = data.result.api;
        if (typeof loom.response === 'undefined') {
          obj.outputMsg = 'Errore Chiusura Ordine. Vedere Apache Error Log lati API';
          _advise(obj);
          return;
        }
        if (loom.body.length === 1 && loom.body[0].State === 'solved') {
          obj.outputMsg = 'Ordine ' + obj.id + ' Chiuso con successo!';
          obj.callbackBtn = function() {
            return obj.Jhide.stop().animate({
              'opacity': '0'
            }, 2000, function() {
              return $(this).remove();
            });
          };
          return _advise(obj);
        } else {
          obj.outputMsg = 'Errore Chiusura Ordine. Vedere Apache Error Log lati API';
          return _advise(obj);
        }
      });
    };
    closing = $('table a');
    closing.on('click', function() {
      var id, obj;
      id = $(this).attr('data-purchase');
      obj = {
        'outputMsg': 'Sei sicuro di voler completare la chiusura?',
        'titleMsg': 'conferma chiusura',
        'id': id,
        'Jhide': $(this).closest('tr'),
        'actionClose': true,
        'callbackBtn': null
      };
      return _advise(obj);
    });
    return {
      plug: 'admin-purchase'
    };
  });

}).call(this);
